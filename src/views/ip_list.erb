<!DOCTYPE HTML>
<HTML>
  <head>
    <title>Posts by IP address <%= addr %></title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" type="text/css" href="/static/dangeru.css">
    <link rel="stylesheet" type="text/css" href="../static/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="../static/css/jquery-ui.min.css">
    <script src="../static/js/jquery-3.2.1.min.js"></script>
    <script src="../static/js/jquery-ui.min.js"></script>
    <link rel="shortcut icon" href="/static/favicon.ico">
    <script src="/static/common.js"></script>
    <style>
      .entry {
        border-left: 2px solid grey;
        padding-left: 10px;
      }
    </style>
    <script>
      $( function() {
        $( "#datepicker" ).datepicker();
      });
    </script>
  </head>
  <body>
    <img src="/static/logo.png" alt="danger/u/" style="width: 395px; height: 130px;">
    <br />
    <div id="maincontainer" style="overflow: hidden; color: white;">
      <div class="title" style="color: #ED145B;">Information for IP <%= Sanitize.clean(addr) %></div>
      <form action="/ban/<%= addr %>" method="post">
        <select id="board" name="board">
          <% session[:moderates].each do |board| %>
            <option value="<%= board %>"><%= board %></option>
          <% end %>
        </select>
        <input type="text" id="datepicker" name="date" placeholder="Date"/>
        <input type="text" id="reason" name="reason" placeholder="Reason" />
        <input type="submit" name="submit" value="Ban" />
      </form>
      <br />
      <% boards = session[:moderates].map do |f| con.escape(f) end %>
      <% boards = "('" + boards.join("', '") + "')" %>
      <% con.query("SELECT reason, board, date_of_unban FROM bans WHERE ip = '#{con.escape(addr)}' AND board IN #{boards} AND date_of_unban > CURRENT_TIMESTAMP()").each do |res| %>
        <h3 class="redtext">
          Banned from <%= res["board"] %> until <%= res["date_of_unban"].strftime '%c' %> for reason "<%= Sanitize.clean(res["reason"]) %>"
          <form action="/unban/<%= addr %>" method="post"><input type="hidden" name="board" value="<%= res["board"] %>" /><input type="submit" name="submit" value="Unban" /></form>
        </h3>
      <% end %>
      <%# We're actually left joining the table `posts` on itself here to get the title of the OP the comment is replying to, if there is one %>
      <% con.query("SELECT posts.*, titles.title AS linked_title FROM posts LEFT JOIN posts titles ON posts.parent = titles.post_id WHERE posts.ip = '#{con.escape(addr)}' AND posts.board IN #{boards}").each do |res| %>
        <% if res["parent"] then %>
          <div class="comment">Reply to
          <%# Links directly to highlight that reply in the thread %>
          <a style='display: inline-block;' href="/<%= res["board"] %>/thread/<%= res["parent"] %>#comment-<%= res["post_id"] %>">
            <%= Sanitize.clean(res["linked_title"]) %>
          </a>
        <% else %>
          <div class="comment">OP with title <a style='display: inline-block;' href="/<%= res["board"] %>/thread/<%= res["post_id"] %>"><%= res["title"] %></a>
        <% end %>
        in /<%= res["board"] %>/ on <%= res["date_posted"].strftime '%c' %>.<i class="fa fa-trash" aria-hidden="true" onClick='deletePost(<%= res["post_id"] %>)'></i></div>
        <div class="entry">
          <div class="comment"><%= Sanitize.clean(res["content"]).gsub("\n", "<br />") %></div>
        </div>
        <br />
      <% end %>
      <div class="title" style="color: #ED145B;">IP Notes</div>
      <% con.query("SELECT content, created FROM ip_notes WHERE ip = '#{con.escape(addr)}' ORDER BY created").each do |res| %>
        <div style="font-size: 50%;">
          <div class="comment"><%= res["created"].strftime '%c' %></div>
        </div>
        <div class="entry">
          <div class="comment"><%= Sanitize.clean(res["content"]).gsub("\n", "<br />") %></div>
        </div>
        <br />
      <% end %>
      <form action="/ip_note/<%= addr %>" method="post" id="ip-note-form">
        <textarea name="content" placeholder="New note for this IP"></textarea>
        <br />
        <button onClick="document.getElementById('ip-note-form').submit()">Submit</button>
      </form>
    </div>
    <footer class="comment" style="font-size: xx-small; text-align: center;">
      <small>Awoo <%= settings.awoo_version %></small>
    </footer>
  </body>
</HTML>
